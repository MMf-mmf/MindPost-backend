{% extends "base/home.html" %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-4xl">
    <div class="mb-6 flex justify-between items-center">
        <a href="{% url 'brain_dump_list' %}" class="text-blue-500 hover:text-blue-700 flex items-center">
            <svg class="h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
            </svg>
            Back to List
        </a>
    </div>

    <div class="bg-white shadow-lg rounded-xl overflow-hidden">
        <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-6">
            <h1 class="text-2xl font-bold">Create Your Post</h1>
            <p class="text-blue-100 mt-2">Based on {{ brain_dumps.count }} selected recording{% if brain_dumps.count != 1 %}s{% endif %}</p>
        </div>
        
        <div class="p-6">
            {% if posts and posts|length > 0 %}
                <div class="mb-6">
                    <h2 class="text-lg font-semibold mb-3">Generated Post Options</h2>
                    <p class="text-gray-600 mb-4">Select a post to edit or use as-is:</p>
                    
                    <div class="space-y-4" id="post-options">
                        {% for post in posts %}
                            <div class="border rounded-lg p-4 hover:bg-gray-50 cursor-pointer post-option {% if forloop.first %}border-blue-500 ring-2 ring-blue-200 bg-blue-50{% else %}border-gray-200{% endif %}" 
                                 data-post="{{ post.post_text }}" data-index="{{ forloop.counter0 }}">
                                <div class="flex justify-between items-start mb-2">
                                    <span class="font-medium text-blue-600">#{{ forloop.counter }}</span>
                                    <span class="text-xs text-gray-500 {% if post.character_count > 5000 %}text-red-500 font-bold{% endif %}">
                                        {{ post.character_count }}/5000 characters
                                    </span>
                                </div>
                                <p class="text-gray-800 mb-3 whitespace-pre-wrap">{{ post.post_text }}</p>
                                {% if post.topics %}
                                    <div class="flex flex-wrap gap-1 mt-2">
                                        {% for topic in post.topics %}
                                            <span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded">{{ topic }}</span>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}

            <form action="{% url 'save_post' %}" method="POST" id="post-form" enctype="multipart/form-data">
                {% csrf_token %}
                
                {% if post %}
                    <input type="hidden" name="post_id" value="{{ post.id }}">
                {% endif %}
                
                <!-- Content input -->
                <div class="mb-6">
                    <label for="content" class="block text-sm font-medium text-gray-700 mb-2">Content</label>
                    <div class="relative">
                        <textarea id="content" name="content" rows="10" required
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">{% if posts and posts|length > 0 %}{{ posts.0.post_text }}{% endif %}</textarea>
                        <div class="absolute bottom-2 right-2 text-xs text-gray-500">
                            <span id="character-count">0</span>/5000
                        </div>
                    </div>
                    <p class="mt-1 text-xs text-gray-500">Maximum 5000 characters</p>
                </div>
                
                <!-- Image Upload Section -->
                <div class="mb-6">
                    <label for="images" class="block text-sm font-medium text-gray-700 mb-2">Upload Images (Max 4)</label>
                    <input type="file" name="images" id="images" multiple accept="image/*"
                           class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                    <p class="mt-1 text-xs text-gray-500">Select up to 4 images to include with your post</p>
                    <div id="image-preview-container" class="mt-4 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 hidden">
                        <!-- Image previews will be inserted here by JavaScript -->
                    </div>
                </div>
                
                <!-- Hidden field for brain dump IDs -->
                <input type="hidden" name="brain_dump_ids" value="{% for dump in brain_dumps %}{{ dump.id }}{% if not forloop.last %},{% endif %}{% endfor %}">
                <input type="hidden" name="action" id="form-action" value="draft">
                
                <!-- Action buttons -->
                <div class="flex justify-between items-center">
                    <div>
                        {% if post and post.id %}
                            <button type="button" 
                                    onclick="if(confirm('Are you sure you want to delete this post?')) { document.getElementById('form-action').value = 'delete'; document.getElementById('post-form').submit(); }" 
                                    class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600">
                                Delete
                            </button>
                        {% endif %}
                    </div>
                    <div class="flex space-x-4">
                        <button type="button" 
                                onclick="document.getElementById('form-action').value = 'draft'; document.getElementById('post-form').submit();"
                                class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600">
                            Save as Draft
                        </button>
                        <button type="button" 
                                onclick="validateAndSubmit()"
                                class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 flex items-center">
                            <svg class="h-4 w-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13a1 1 0 102 0V9.414l1.293 1.293a1 1 0 001.414-1.414z" clip-rule="evenodd" />
                            </svg>
                            Publish
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Character counter for post limit
    document.addEventListener('DOMContentLoaded', function() {
        const textarea = document.getElementById('content');
        const charCount = document.getElementById('character-count');
        
        // Helper function to update character count
        function updateCharacterCount() {
            const count = textarea.value.length;
            charCount.textContent = count;
            
            // Visual feedback when over limit
            if (count > 5000) {
                charCount.classList.add('text-red-500', 'font-bold');
            } else {
                charCount.classList.remove('text-red-500', 'font-bold');
            }
        }
        
        // Update count on input
        textarea.addEventListener('input', updateCharacterCount);
        
        // Setup post option selection
        const postOptions = document.querySelectorAll('.post-option');
        postOptions.forEach(option => {
            option.addEventListener('click', function() {
                // Remove highlighting from all options
                postOptions.forEach(opt => {
                    opt.classList.remove('border-blue-500', 'ring-2', 'ring-blue-200', 'bg-blue-50');
                    opt.classList.add('border-gray-200');
                });
                
                // Add highlighting to selected option
                this.classList.remove('border-gray-200');
                this.classList.add('border-blue-500', 'ring-2', 'ring-blue-200', 'bg-blue-50');
                
                // Update textarea content
                textarea.value = this.getAttribute('data-post');
                updateCharacterCount();
            });
        });
        
        // Image Preview Handling
        const imageInput = document.getElementById('images');
        const previewContainer = document.getElementById('image-preview-container');

        if (imageInput) {
            imageInput.addEventListener('change', handleImageFiles);
        }

        function handleImageFiles() {
            clearImagePreviews(); // Clear existing previews first
            const files = imageInput.files;
            
            if (files.length > 0) {
                previewContainer.classList.remove('hidden'); // Show container if hidden
            } else {
                previewContainer.classList.add('hidden'); // Hide if no files selected
                return;
            }
            
            // Show warning if more than 4 files selected
            if (files.length > 4) {
                alert('Maximum 4 images allowed. Only the first 4 will be used.');
            }
            
            // Process up to 4 files
            const maxFiles = Math.min(files.length, 4);
            for (let i = 0; i < maxFiles; i++) {
                const file = files[i];
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const previewContainer = document.getElementById('image-preview-container');
                        const previewWrapper = document.createElement('div');
                        previewWrapper.className = 'relative group';
                        
                        const imgElement = document.createElement('img');
                        imgElement.src = e.target.result;
                        imgElement.alt = `Preview of ${file.name}`;
                        imgElement.className = 'w-full h-40 object-cover rounded-md';
                        
                        const removeButton = document.createElement('button');
                        removeButton.type = 'button';
                        removeButton.className = 'absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity';
                        removeButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>';
                        removeButton.addEventListener('click', function() {
                            // Remove this preview
                            previewWrapper.remove();
                            
                            // Hide container if no previews left
                            if (previewContainer.children.length === 0) {
                                previewContainer.classList.add('hidden');
                            }
                        });
                        
                        previewWrapper.appendChild(imgElement);
                        previewWrapper.appendChild(removeButton);
                        previewContainer.appendChild(previewWrapper);
                    };
                    reader.readAsDataURL(file);
                }
            }
        }

        function clearImagePreviews() {
            const previewContainer = document.getElementById('image-preview-container');
            previewContainer.innerHTML = '';
            previewContainer.classList.add('hidden');
        }
        
        // Initial count - Call this after all the DOM manipulation is done
        updateCharacterCount();
    });
    
    // Validation before publishing
    function validateAndSubmit() {
        const textarea = document.getElementById('content');
        const charLimit = 5000;
        
        if (textarea.value.trim() === '') {
            alert('Please add content to your post before publishing.');
            return;
        }
        
        const charCount = textarea.value.length;
        
        if (charCount > charLimit) {
            if (!confirm(`Your post contains ${charCount} characters, which exceeds the ${charLimit} character limit.\n\nThe post may be truncated when published.\n\nDo you wish to continue?`)) {
                return;
            }
        }
        
        // Set action and submit
        document.getElementById('form-action').value = 'publish';
        document.getElementById('post-form').submit();
    }
</script>
{% endblock %}
